# SPEC-0008: Visual Edit 迁移执行清单

> 目标：基于 UPGRADE-VISUAL-EDIT.md 的 Phase 1~4，给出“具体修改文件清单 + 迁移步骤 + 风险/回滚策略”。

---

## A. 具体修改文件清单

### Phase 1: `vite-plugin-jsx-tagger` 集成（高）

**需要修改/新增：**
- `fly-server/src/services/scaffolder.ts`
  - 生成项目时不再写入 `jsx-tagger-plugin.js`（本地静态插件）。
  - `generateViteConfig()` 改为从包导入 `vite-plugin-jsx-tagger`。
- `packages/vite-plugin-jsx-tagger/package.json`
  - 确保可通过 workspace 引用（如 `workspace:*`）。
- 生成项目 `package.json` 模板
  - 增加依赖 `vite-plugin-jsx-tagger`（devDependencies）。

**可删除/清理：**
- `fly-server/static/jsx-tagger-plugin.js`（若不再使用）。
- `fly-server` 同步脚本（如存在 `sync:jsx-tagger`）。

---

### Phase 2: `visual-edit-script` 注入统一（中）

**需要修改/明确路径：**
- `fly-server/src/index.ts`
  - 保留注入脚本逻辑或与 backend 统一，避免双路径注入。
- `backend/src/routes/proxy.ts`
  - 若统一由 fly-server 注入，可移除这里的注入逻辑；或反之。

**可删除/清理：**
- `fly-server/static/visual-edit-script.js`（如果仍存在）。

---

### Phase 3: Visual Editor UI 全量接入（中高）

**需要修改/替换：**
- `frontend/src/components/VisualEditPanel.tsx`
  - 用 `visual-editor` 包的 `Editor/PropertyPanel` 替代自实现面板。
- `frontend/src/components/PreviewFrame.tsx`
  - 与 `visual-editor` 的 `Preview/IframeWrapper` 接口对齐。
- `frontend/src/App.tsx` 或相关页面
  - 调整引入与布局，确保 `visual-editor` 组件接管可视化编辑区域。

**可能新增/适配：**
- `frontend/src/components/VisualEditorAdapter.tsx`（可选）
  - 负责 props 兼容、消息转发与 API 接口适配。

---

### Phase 4: AST 处理统一接口（高）

**需要修改/新增：**
- `backend/src/services/ast/adapter.ts`
  - 新增统一接口适配层，实现 `TransformRequest/Result`。
- `backend/src/routes/code-editor.ts`
  - 改为调用统一接口（adapter），避免直接使用本地实现细节。
- `backend/src/services/ast/index.ts`
  - 继续保留 SWC core 实现，但对齐 `ast-processor` 的接口类型。
- `packages/ast-processor`（可选）
  - 如果决定服务端直接引入包，则需调整依赖策略与构建方式。

---

## B. 迁移步骤（Phase 1~4）

### Phase 1: jsx-tagger 包化
1) 修改脚手架 `package.json` 模板，加入 `vite-plugin-jsx-tagger` 依赖。
2) 修改 `generateViteConfig()` 使用 `import { jsxTaggerPlugin } from 'vite-plugin-jsx-tagger'`。
3) 移除生成项目中的 `jsx-tagger-plugin.js` 写入逻辑。
4) 删除/废弃 `fly-server/static/jsx-tagger-plugin.js` 以及同步脚本。
5) 验证：生成项目后 DOM 是否有 `data-jsx-id/file/line/col`。

### Phase 2: 统一注入路径
1) 选择单一注入路径：
   - 方案 A：仅由 `fly-server` 注入脚本。
   - 方案 B：仅由 `backend proxy` 注入脚本。
2) 移除另一条路径的注入逻辑。
3) 验证：预览中元素可选中/高亮/拖拽，消息通道正常。

### Phase 3: UI 迁移
1) 选择迁移策略：
   - 方案 A：直接替换为 `visual-editor` 的 `Editor/PropertyPanel`。
   - 方案 B：逐步替换（先面板、后预览、再工具栏）。
2) 在前端引入 `visual-editor` 组件并调整布局。
3) 适配选中元素结构与事件回调（可使用 adapter 组件）。
4) 验证：文本/样式/布局修改可保存，撤销/重做可用。

### Phase 4: AST 统一
1) 新增 `adapter.ts`，实现统一接口并复用 SWC core 实现。
2) `code-editor` 路由切换到 adapter API。
3) 若引入 `packages/ast-processor`：调整依赖与运行环境。
4) 验证：位置匹配、文本匹配、样式更新、批量更新。

---

## C. 风险与回滚策略

### Phase 1 风险与回滚
- 风险：生成项目构建失败（包未解析/依赖缺失）。
- 回滚：恢复内联插件写入逻辑与 `jsx-tagger-plugin.js`。

### Phase 2 风险与回滚
- 风险：预览未注入脚本或重复注入导致冲突。
- 回滚：保留双路径注入（短期），再逐步收敛。

### Phase 3 风险与回滚
- 风险：UI 功能缺失、交互不完整、消息断链。
- 回滚：保留原 `VisualEditPanel + PreviewFrame` 并切换开关。

### Phase 4 风险与回滚
- 风险：AST 匹配失败或性能下降。
- 回滚：继续使用现有 `backend/src/services/ast` 逻辑，逐步替换。

---

## D. 优先级建议
1) Phase 1（高）——基础依赖统一，影响全链路。
2) Phase 4（高）——编辑正确性与可扩展性。
3) Phase 3（中高）——UI 统一与维护成本。
4) Phase 2（中）——路径统一，风险较低。

---

## E. 迁移验证 Checklist（端到端）

### E1. 依赖与脚手架（Phase 1）
- [ ] 生成项目 `package.json` 含 `vite-plugin-jsx-tagger` 依赖（devDependencies）。
- [ ] 生成项目 `vite.config.ts` 使用 `import { jsxTaggerPlugin } from 'vite-plugin-jsx-tagger'`。
- [ ] 生成项目目录中 **不存在** `jsx-tagger-plugin.js`。
- [ ] 运行 dev server 后 DOM 含 `data-jsx-id/file/line/col`。

### E2. 注入路径（Phase 2）
- [ ] 通过 `/api/proxy/:projectId` 预览页面仅出现一次 `visual-edit-script` 注入。
- [ ] 不再由 backend proxy 二次注入脚本（检查 HTML）。
- [ ] 预览中元素可选中/高亮/拖拽。

### E3. UI 迁移（Phase 3）
- [ ] 左侧面板显示 `visual-editor` 的 PropertyPanel（含标签页）。
- [ ] 点击元素后面板信息刷新（标签、class、样式）。
- [ ] 调整颜色/间距/布局/效果时，iframe 实时变更。
- [ ] `.map()` 列表元素编辑命中正确项（elementIndex 生效）。
- [ ] 点击保存后，后端成功写入并触发 HMR。

### E4. AST 统一（Phase 4）
- [ ] `code-editor` 路由走统一 `astProcessor` 适配层。
- [ ] 文本更新：优先 position 匹配成功。
- [ ] 样式更新：className 与 style 均可更新。
- [ ] 批量更新：全部成功且变更记录返回正常。

### E5. E2E 运行步骤（建议顺序）
1) 构建包：`packages/vite-plugin-jsx-tagger`、`packages/visual-editor`（生成 dist）。
2) 启动 backend、fly-server、frontend。
3) 生成新项目 → 进入设计模式 → 选中元素 → 修改样式 → 保存。
4) 验证 HMR 热更新生效（无整页刷新）。
